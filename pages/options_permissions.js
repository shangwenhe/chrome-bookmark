import{$ as e,OnEdge as o,browser_ as t,OnFirefox as r,OnChrome as i,nextTick_ as s,CurCVer_ as n,IsEdg_ as l,post_ as a,pageLangs_ as m,prevent_ as p}from"./async_bg.js";import{Option_ as f,oTrans_ as d,bgSettings_ as c,delayBinding_ as u}from"./options_base.js";import{registerClass_ as _,createNewOption_ as h,TextOption_ as g}from"./options_defs.js";let v=t.permissions,w=e=>{if(!v)return function(){return a(25,{module:"permissions",name:e,args:[].slice.call(arguments)})};let o=v[e];return function(){let e=[].slice.call(arguments);return new Promise(r=>{e.push(e=>{let o=t.runtime.lastError;return r(o?[void 0,o]:[e,void 0]),o}),o.apply(v,e)})}},P={contains:w("contains"),request:w("request"),remove:w("remove")},b=navigator.permissions,O="downloads.shelf",U="chrome://new-tab-page/*",x="chrome://*/*",y={"clipboard-read":"opt_clipboardRead",[x]:"opt_chromeUrl",[U]:"opt_cNewtab",[O]:"opt_closeShelf"},C=e("#optionalPermissionsTemplate"),B=C.content.firstElementChild,S=C.parentElement,j=e("#navPermissionTip"),q=e("#gotoCrSC"),F=[];export const manifest_=t.runtime.getManifest();let N=manifest_.optional_permissions||[],k=["clipboard-read"];export class OptionalPermissionsOption_ extends f{R(){u(this.x,"change",this.v)}z(){return F.map(e=>e.x.indeterminate?"1":e.x.checked?"2":"0").join("")}E(){return F.map(e=>e.S).join("")}N(e){for(let o=0;o<F.length;o++){let t=F[o];t.x.checked="2"===e[o],t.x.indeterminate="1"===e[o],2===t.ae&&"1"!==e[o]&&(t.x.parentElement.title=j.innerText)}}J(e){let o=[],t=[],r=[],i={},n=1,a=false;for(let s=0;s<F.length;s++){let l=F[s],m=+e[s];if(l.S===m)continue;let f=l.me===U?"chrome://newtab/*":"";l.S=m,l.me===x&&c.h("allBrowserUrls")!==(2===m)&&(n++,Promise.resolve(c.h("allBrowserUrls")).then(e=>{e!==(2===m)?c.p("allBrowserUrls",2===m).then(p):p()})),2===l.ae?2===m?r.push(l.me):a=true:m?(l.me===O&&o.push("downloads"),(1===l.ae?t:o).push(l.me),f&&t.push(f),i[l.me]=l):(n++,P.remove(1===l.ae?{origins:f?[l.me,f]:[l.me]}:{permissions:l.me===O?["downloads",l.me]:[l.me]}).then(([e,o])=>{let t="Can not remove the permission %o : ",r=o&&o.message||o;(o||!e)&&console.log(t,l.me,r);let i=l.x.parentElement;g.ne(o?t.replace("%o",l.me)+r:"",void 0,i),p()}))}let m=(e,[o,t])=>{if((t||!o)&&console.log("Can not request permissions of %o :",e,t&&t.message||t),!o){for(let o of e){let e=i[o];if(!e)continue;e.S=0;let r=e.x.parentElement;if(!t)return g.ne("",void 0,r);let n=(t&&t.message||JSON.stringify(t))+"";o.startsWith("chrome://")&&n.includes("Only permissions specified in the manifest")&&o.startsWith("chrome:")&&(n=d("optNeedChromeUrlFirst"),n=l?n.replace("chrome","edge"):n),n=d("exc")+n,g.ne(n,void 0,r),s(()=>{r.title=n})}this.w()}p()},p=()=>{n--,n>0||Promise.all(F.map(T)).then(()=>{this.w(),a&&q.click()})};if(n+=(o.length&&1)+(t.length&&1),o.length&&P.request({permissions:o}).then(m.bind(0,o)),t.length&&P.request({origins:t}).then(m.bind(0,t)),r.includes("clipboard-read")){let e=navigator.clipboard;n++,e.readText().catch(()=>{}).then(p)}return p(),Promise.resolve(e)}}_("OptionalPermissions",OptionalPermissionsOption_);let E=()=>{let e=document.createDocumentFragment();for(let o of F){let t=o.me,r=document.importNode(B,true),i=r.querySelector("input"),s=d(y[t]||`opt_${t}`)||t,n="";t.startsWith("chrome:")&&(s=l?s.replace("chrome:","edge:"):s,n=d("optOfChromeUrl").replace(l?"chrome":"edge","edge")),i.name=t,r.lastElementChild.textContent=s+n,(1===N.length||2===N.length&&"en"===m)&&r.classList.add("single"),e.append(r),o.x=i}S.append(e),u(S,"input",J,true),q&&u(q,"click",R,true)},T=e=>{let{ae:o,me:t}=e;return(2===o?b.query({name:t}).then(e=>["prompt"===e.state?1:"granted"===e.state?2:0,void 0],e=>[void 0,e]):P.contains(1===o?{origins:[t]}:{permissions:t===O?["downloads",t]:[t]})).then(([o])=>{let r=o?2===e.ae?o:t!==x||c.h("allBrowserUrls")?2:1:0;e.S=r})},J=e=>{let o=e.target,t=F.find(e=>e.x===o);if(!t)return;let r=o.checked;if(t.me===x||t.me===U){let e=t.me===U,i=e?x:U,s=F.find(e=>e.me===i);s&&(e&&r&&!s.x.checked?(s.x.checked=false,s.x.indeterminate=true):!e&&r&&o.indeterminate?o.indeterminate=false:(s.x.checked=r,s.x.indeterminate=false))}2===t.ae&&(o.checked||(o.indeterminate=true))},R=e=>{p(e),a(15,{u:e.target.href,p:false})};{let e=["downloads"];l&&e.push(U),e.push("cookies"),N=N.concat(manifest_.optional_host_permissions),N=N.filter(o=>!e.some(e=>"string"==typeof e?o===e:e.test(o)))}if(N.length||k.length){for(let e of k)F.push({me:e,ae:2,S:1,x:null});for(let e of N)F.push({me:e,ae:e.includes(":")?1:0,S:0,x:null});j&&s(()=>{j.style.display=""}),s(E,9),Promise.all(F.map(T)).then(()=>{s(()=>{S.dataset.model="OptionalPermissions",h(S).w()})})}else s(()=>{e("#optionalPermissionsBox").style.display="none"},9);