import{CurCVer_ as t,OnChrome as e,$ as i,$$ as s,nextTick_ as n,pageLangs_ as l,pageTrans_ as o,post_ as r,enableNextTick_ as a,onDicts_ as u,curPagePath_ as h,setupPageOs_ as _}from"./async_bg.js";let c={};export const showI18n_=()=>{if("en"===l)return;let t=l.split(",")[0],e=navigator.language||t,n=i("#keyMappings"),r=n&&oTrans_("keyMappingsP");if(r&&(n.placeholder=r),e&&(!t.startsWith("zh")||"zh-CN"!==e))for(n of s("input[type=text], textarea"))n.lang=e;for(n of s("[data-i]")){let t=n.dataset.i,e=t.endsWith("-t");r=o(e?t.slice(0,-2):t),null!=r&&(e?n.title=r:n.textContent=r)}document.documentElement.lang="zh"===t?"zh-CN":t};window.__extends=function(t,e){let i=function(){this.constructor=t};i.prototype=e.prototype,t.prototype=new i};export const debounce_=(t,e,i,s)=>{let n,l=0,o=()=>{let r=Date.now()-n;if(!(r<e-4&&r>=0))return l=0,n!==s?t.call(i):void 0;l=setTimeout(o,e-r)};return s=s?1:0,()=>{if(n=Date.now(),!l)return l=setTimeout(o,e),s?(s=n,t.call(i)):void 0;s&&(s=n-1)}};export const didBindEvent_=t=>{let e="string"!=typeof t?t.type:t;for(let t of c[e]||[])for(let i of"string"==typeof t.t?s(t.t):[t.t])"on"!==t.e?i.addEventListener(e,t.s,t.e):i["on"+e]=t.s;c[e]=null,removeEventListener(e,didBindEvent_,true)};export const delayBinding_=(t,e,i,s)=>{let n=c[e];n||(addEventListener(e,didBindEvent_,true),n=c[e]=[]),n.push({t,s:i,e:s||false})};let p="__locking",d=null;export const setupSettingsCache_=t=>{d=t};export const getSettingsCache_=()=>d;export const bgSettings_={o:"",r:null,a(){d=null},u:()=>d?d instanceof Promise?d:Promise.resolve():(bgSettings_.r||r(0).then(t=>{bgSettings_.r=t[0],_(t[1]),bgSettings_.o=t[2],a(1)}),d=r(1).then(t=>{d=t})),h(t){if(null==d&&this.u(),d instanceof Promise)return d.then(()=>this.h(t));let e=d[t];return void 0!==e?e:this.r[t]},p(t,e){let i=bgSettings_.r[t],s=e;return void 0!==i&&("object"==typeof i?JSON.stringify(e)===JSON.stringify(i):e===i)&&(s=null),r(2,{key:t,val:s}).then(i=>{d[t]=null!==i?i:e})},f:{__proto__:null,filterLinkHints:"f",keyLayout:"l",mouseReachable:"e",keyboard:"k",keyupTime:"u",linkHintCharacters:"c",linkHintNumbers:"n",passEsc:"p",regexFindMode:"r",smoothScroll:"s",scrollStepSize:"t",waitForEnter:"w"},g:{__proto__:null,c:1,n:1,l:1,d:1}};bgSettings_.u(),u(await Promise.all(l.split(",").map(t=>import(`/i18n/${t}/${h}.js`))));export class Option_{m(){}constructor(t,e){let i=t.id;this.y=i,this.x=t,this.S=this.v=null,this.O=false,i in bgSettings_.f?e=this.b.bind(this,e):"autoDarkMode"!==i&&"autoReduceMotion"!==i||(e=this.k.bind(this,e)),this.v=debounce_(e,330,this,1),this.R(t)}w(){this.O=true;let t=this.E();if(t instanceof Promise)return t.then(Option_.prototype.w.bind(this));this.S=t,Option_.$||n(()=>{this.N(this.S)})}E(){return bgSettings_.h(this.y)}B(t){let e=this.P;return e?e.T(t):t}C(){return true}async K(){let t=this.z(),e="object"==typeof t,i=e?JSON.stringify(this.S):this.S,s=e?JSON.stringify(t):t;if(s===i)return;i=s;let l=this.B(t);return t=l instanceof Promise?await l:l,t=await this.J(t),this.S=t,this.O=true,(i!==(e?JSON.stringify(t):t)||this.L(t))&&n(()=>{this.N(this.S,true)}),this.m()}M(){let t=this.E(),e=!this.j(this.S,t);return e&&this.j(t,this.z())?(this.S=t,this.O=true,false):e}async J(t){return await bgSettings_.p(this.y,t),this.y in bgSettings_.f&&Option_.F.push(this.y),this.E()}L(t){return false}j(t,e){return t===e}}Option_.D={},Option_.F=null,Option_.V=null,Option_.$=false;export class ExclusionRulesOption_ extends Option_{R(t){this.A=t.querySelector("#exclusionTemplate").content.querySelector(".exclusionRule"),this.H=t.querySelector("tbody"),this.q=[],delayBinding_(this.H,"input",ExclusionRulesOption_.Z),delayBinding_(this.H,"input",this.v),delayBinding_(this.H,"click",t=>this.I(t)),this.W=false,delayBinding_("#exclusionAddButton","click",()=>this.G(""),"on")}Q(t){}static Z(t){let e=t.target,i=e.vnode;i&&(i.U|=e.classList.contains("pattern")?1:2)}G(t,e){let i=false!==e,s=i&&this.H.childElementCount,l=this.X(this.H,{passKeys:"",pattern:t});t&&(l.Y={passKeys:"",pattern:""});let o=this.q[this.q.length-1];i&&(s>=4&&this.x.scrollBy(0,40),n(()=>o.tt.focus())),t&&this.v(),this.Q(1)}N(t){if(!this.W){this.W=true,Option_.F&&(this.A.draggable=true);for(let t of"en"!==l?s("[title]",this.A):[]){let e=o(t.title);e&&(t.title=e)}}if(this.H.innerText="",this.q=[],t.length<=0);else if(1===t.length)this.X(this.H,t[0]);else{let e=document.createDocumentFragment();t.forEach(this.X.bind(this,e)),this.H.append(e)}return this.Q(t.length)}et(t){return true}X(t,e){let{passKeys:i,pattern:s}=e,n={it:e,st:null,U:0,nt:false,tt:null,lt:null,Y:e};if(n.nt=this.et(n),!n.nt)return this.q.push(n),n;let l=document.importNode(this.A,true),o=l.querySelector(".pattern"),r=l.querySelector(".passKeys"),a=i.trimRight();return o.value=s,s&&(o.placeholder=""),r.value=a,a&&(r.placeholder=""),n.tt=o,n.lt=r,o.vnode=n,r.vnode=n,this.ot(n,s,i),this.q.push(n),t.append(l),n}static rt(t){t.it.pattern&&t.lt.placeholder&&(t.lt.placeholder="")}I(t){let e=t.target;if("path"===e.localName&&(e=e.parentElement),"svg"===e.localName&&(e=e.parentElement),e.classList.contains("remove")&&(e=e.parentNode.parentNode,e.classList.contains("exclusionRule"))){let t=e.querySelector(".pattern").vnode;return e.remove(),4&t.U&&t.Y.pattern?Object.assign(t,{it:{passKeys:"",pattern:""},st:false,U:12,tt:null,lt:null}):this.q.splice(this.q.indexOf(t),1),this.v(),this.Q(0)}}static at(t,e,i){let s=i.toLowerCase();return e||1!==i.length?i!==s?`<${e}s-${s}>`:t:i}static ut(t){return t&&t.replace(/<(?!<)((?:[acm]-){0,3})(\S|[A-Za-z]\w+)>/g,ExclusionRulesOption_.at)}z(t){let e=[];t=true===t;for(let i of this.q){if(t&&!i.nt)continue;let s=i.U;if(!(s&&3&s)){i.it.pattern&&e.push(i.it);continue}let n=1&s?i.tt.value.trim():i.it.pattern,l=false,o=2&s?i.lt.value:i.it.passKeys;if(n){if(1&s){let t=/^(about|vimium):/i.test(n),e=n.startsWith(":")?0:n.indexOf("://");if(e)if(/^[\^*]|[^\\][$()*+?\[\]{|}]/.test(n))if(n.startsWith("`"));else if(n.startsWith("^")){let t=".*$".includes(n.slice(-2))?n.endsWith(".*$")?3:n.endsWith(".*")?2:0:0;n=0!==t&&"\\"!==n[n.length-t]?n.slice(0,-t):n}else{l=!n.includes("/",e+3),n.endsWith("*")&&(n=n.slice(0,/^[^\\]\.\*$/.test(n.slice(-3))?-2:-1),l=false),n=n.startsWith(".*")&&!/[(\\[]/.test(n)?"*."+n.slice(2):n;let i=n;i=(e<0&&!t?"^https?://":"^")+(i.startsWith("*")&&"."!==i[1]?"[^/]"+i:(i=i.replace(/\./g,"\\."),i.startsWith("*")?i.replace("*\\.","(?:[^./]+\\.)*?"):i.replace("://*\\.","://(?:[^./]+\\.)*?"))),n=f(i,"")?i:n.includes("*")||n.includes("/")||t?":"+n:":https://"+(n.startsWith(".")?n.slice(1):n)}else l=!n.includes("/",e+3)&&!t,n=n.replace(/\\(.)/g,"$1"),n=(e<0&&!t?":http://":":")+n;l&&(n+="/")}if(2&s&&o){o=ExclusionRulesOption_.ut(o);let t=o.match(/<(?!<)(?:a-)?(?:c-)?(?:m-)?(?:s-)?(?:[a-z]\w+|[^\sA-Z])>|\S/g);if(t){let e="^"===t[0]&&t.length>1;e&&t.shift(),t.sort(),e?t.unshift("^"):"^"===t[0]&&(t.shift(),t.push("^"))}o=t?t.join(" ")+" ":"",o=o.replace(/<escape>/gi,"<esc>")}this.ot(i,n,o),e.push(i.it)}else this.ot(i,"",o)}return e}ot(t,e,i){let s=!t.it.passKeys&&!!i;t.it={passKeys:i,pattern:e},t.st=null,t.U&=-4,s&&ExclusionRulesOption_.rt(t)}m(){for(let t=0,e=this.q;t<e.length;t++){let i=e[t];if(!i.nt)continue;if(8&i.U){e.splice(t--,1);continue}i.Y=i.it,i.tt.value!==i.it.pattern&&(i.tt.value=i.it.pattern);let s=i.it.passKeys.trim();i.lt.value!==s&&(i.lt.value=s)}}j(t,e){return JSON.stringify(t)===JSON.stringify(e)}}let f=(t,e)=>{try{return new RegExp(t,e)}catch(t){return null}};export let setupBorderWidth_=devicePixelRatio<2&&true?()=>{let t=document.createElement("style"),e=devicePixelRatio,i=e>=1,s=1/e;s+=999e-8,s=(""+s).slice(0,7).replace(/\.?0+$/,""),t.textContent=i?`html { --vc-tiny: ${s}px; }`:`* { border-width: ${s}px !important; }`,document.head.append(t)}:null;export const oTrans_=(t,e)=>o(t,e)||"";